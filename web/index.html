<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ECG Digitization</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          sans-serif;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f3460 100%
        );
        min-height: 100vh;
        color: #fff;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Header */
      header {
        text-align: center;
        padding: 40px 0 30px;
      }

      header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: linear-gradient(90deg, #00d4ff, #7c3aed);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      header p {
        color: #94a3b8;
        font-size: 1.1rem;
      }

      /* Upload Section */
      .upload-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 40px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
      }

      .upload-area {
        border: 2px dashed rgba(124, 58, 237, 0.5);
        border-radius: 15px;
        padding: 60px 40px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .upload-area:hover,
      .upload-area.dragover {
        border-color: #7c3aed;
        background: rgba(124, 58, 237, 0.1);
      }

      .upload-area input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
      }

      .upload-icon {
        font-size: 4rem;
        margin-bottom: 20px;
      }

      .upload-area h3 {
        font-size: 1.3rem;
        margin-bottom: 10px;
      }

      .upload-area p {
        color: #94a3b8;
      }

      /* Preview Section */
      .preview-section {
        display: none;
        margin-top: 30px;
      }

      .preview-section.show {
        display: block;
      }

      .preview-container {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        flex-wrap: wrap;
      }

      .preview-image {
        flex: 1;
        min-width: 300px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        padding: 15px;
      }

      .preview-image img {
        width: 100%;
        border-radius: 10px;
      }

      .preview-info {
        flex: 1;
        min-width: 250px;
      }

      .file-info {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .file-info p {
        margin: 8px 0;
        color: #94a3b8;
      }

      .file-info span {
        color: #fff;
        font-weight: 500;
      }

      /* Process Button */
      .btn {
        padding: 15px 40px;
        font-size: 1.1rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .btn-primary {
        background: linear-gradient(135deg, #7c3aed, #00d4ff);
        color: #fff;
        width: 100%;
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        margin-right: 10px;
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* Processing State */
      .processing {
        display: none;
        text-align: center;
        padding: 40px;
      }

      .processing.show {
        display: block;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top-color: #7c3aed;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .processing h3 {
        margin-bottom: 10px;
      }

      .processing p {
        color: #94a3b8;
      }

      /* Results Section */
      .results-section {
        display: none;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 40px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
      }

      .results-section.show {
        display: block;
      }

      .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .results-header h2 {
        color: #10b981;
      }

      .success-badge {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 0.9rem;
      }

      /* Results Grid */
      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .result-card {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 15px;
        padding: 20px;
      }

      .result-card h4 {
        margin-bottom: 15px;
        color: #00d4ff;
      }

      .waveform-image {
        width: 100%;
        border-radius: 10px;
        margin-bottom: 10px;
      }

      /* Metadata */
      .metadata-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .metadata-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 12px;
        border-radius: 8px;
      }

      .metadata-item label {
        font-size: 0.8rem;
        color: #94a3b8;
        display: block;
      }

      .metadata-item span {
        font-weight: 600;
        color: #fff;
      }

      /* Download Links */
      .download-links {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 20px;
      }

      .download-link {
        background: rgba(124, 58, 237, 0.2);
        color: #a78bfa;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .download-link:hover {
        background: rgba(124, 58, 237, 0.4);
        color: #fff;
      }

      /* CSV Data Table */
      .csv-section {
        display: none;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
      }

      .csv-section.show {
        display: block;
      }

      .csv-section h4 {
        color: #00d4ff;
        margin-bottom: 15px;
      }

      .csv-info {
        color: #94a3b8;
        margin-bottom: 15px;
        font-size: 0.9rem;
      }

      .csv-table-container {
        overflow-x: auto;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 10px;
        max-height: 400px;
        overflow-y: auto;
      }

      .csv-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        font-family: "Courier New", monospace;
      }

      .csv-table th {
        background: rgba(124, 58, 237, 0.3);
        color: #a78bfa;
        padding: 8px;
        text-align: left;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .csv-table td {
        padding: 6px 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #e2e8f0;
      }

      .csv-table tr:hover {
        background: rgba(124, 58, 237, 0.1);
      }

      /* Error State */
      .error-message {
        display: none;
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        color: #fca5a5;
      }

      .error-message.show {
        display: block;
      }

      /* New Upload Button */
      .new-upload-btn {
        margin-top: 20px;
      }

      /* Footer */
      footer {
        text-align: center;
        padding: 30px;
        color: #64748b;
        font-size: 0.9rem;
      }

      /* Responsive */
      @media (max-width: 768px) {
        header h1 {
          font-size: 1.8rem;
        }

        .upload-section {
          padding: 20px;
        }

        .upload-area {
          padding: 40px 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ü´Ä ECG Digitization</h1>
        <p>Convert paper ECG scans into digital signals using AI</p>
      </header>

      <!-- Upload Section -->
      <section class="upload-section" id="uploadSection">
        <div class="upload-area" id="uploadArea">
          <input type="file" id="fileInput" accept="image/*" />
          <div class="upload-icon">üì§</div>
          <h3>Drop your ECG image here</h3>
          <p>or click to browse (PNG, JPG, JPEG, BMP, TIFF)</p>
        </div>

        <!-- Preview -->
        <div class="preview-section" id="previewSection">
          <div class="preview-container">
            <div class="preview-image">
              <img id="previewImg" src="" alt="ECG Preview" />
            </div>
            <div class="preview-info">
              <div class="file-info">
                <p>üìÅ File: <span id="fileName">-</span></p>
                <p>üìê Size: <span id="fileSize">-</span></p>
                <p>üñºÔ∏è Type: <span id="fileType">-</span></p>
              </div>
              <button class="btn btn-primary" id="processBtn">
                ‚ö° Process ECG
              </button>
            </div>
          </div>
        </div>

        <!-- Processing State -->
        <div class="processing" id="processingState">
          <div class="spinner"></div>
          <h3>Processing your ECG...</h3>
          <p>
            Running nnU-Net 5-fold ensemble inference. This may take 20-60
            seconds.
          </p>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage">
          <strong>‚ö†Ô∏è Error:</strong> <span id="errorText"></span>
        </div>
      </section>

      <!-- Results Section -->
      <section class="results-section" id="resultsSection">
        <div class="results-header">
          <h2>‚úÖ Results</h2>
          <span class="success-badge" id="successBadge"
            >Processing Complete</span
          >
        </div>

        <!-- Comparison Grid: Original vs Digitized (First Row) -->
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
          "
        >
          <!-- Original Image -->
          <div class="result-card" id="originalCard" style="background: #fff">
            <h4 style="color: #1a1a2e">üì∑ Original Input</h4>
            <img
              id="originalImg"
              class="waveform-image"
              src=""
              alt="Original ECG"
              style="
                width: 100%;
                max-width: 100%;
                border-radius: 10px;
                background: #fff;
              "
            />
          </div>

          <!-- Digitized B/W Image -->
          <div class="result-card" id="waveformCard" style="background: #fff">
            <h4 style="color: #1a1a2e">üñ§ Digitized Trace (Masked)</h4>
            <img
              id="waveformImg"
              class="waveform-image"
              src=""
              alt="Digitized ECG"
              style="
                width: 100%;
                max-width: 100%;
                border-radius: 10px;
                background: #fff;
              "
            />
          </div>
        </div>

        <!-- Plot (Full Width Below) -->
        <div
          class="result-card"
          id="plotCard"
          style="background: #fff; margin-bottom: 20px"
        >
          <h4 style="color: #1a1a2e">üìà Signal Plot</h4>
          <img
            id="plotImg"
            class="waveform-image"
            src=""
            alt="Signal Plot"
            style="
              width: 100%;
              max-width: 100%;
              border-radius: 10px;
              background: #fff;
            "
          />
        </div>

        <!-- CSV Data Preview -->
        <div class="csv-section" id="csvSection">
          <h4>üìä Digitized Signal Data (CSV Preview)</h4>
          <p class="csv-info" id="csvInfo">
            Showing first 10 rows of <span id="totalRows">0</span> total data
            points
          </p>
          <div class="csv-table-container">
            <table class="csv-table" id="csvTable">
              <!-- Filled by JS -->
            </table>
          </div>
        </div>

        <!-- Download Button -->
        <div class="download-links" id="downloadLinks">
          <!-- Filled by JS - only waveform download -->
        </div>

        <!-- New Upload Button -->
        <button class="btn btn-secondary new-upload-btn" id="newUploadBtn">
          ‚Ü©Ô∏è Process Another ECG
        </button>
      </section>

      <footer>
        <p>ECG Digitization Pipeline ‚Ä¢ nnU-Net 5-Fold Ensemble ‚Ä¢ Phase 1</p>
      </footer>
    </div>

    <script>
      // DOM Elements
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const previewSection = document.getElementById("previewSection");
      const previewImg = document.getElementById("previewImg");
      const fileName = document.getElementById("fileName");
      const fileSize = document.getElementById("fileSize");
      const fileType = document.getElementById("fileType");
      const processBtn = document.getElementById("processBtn");
      const processingState = document.getElementById("processingState");
      const errorMessage = document.getElementById("errorMessage");
      const errorText = document.getElementById("errorText");
      const resultsSection = document.getElementById("resultsSection");
      const waveformImg = document.getElementById("waveformImg");
      const waveformCard = document.getElementById("waveformCard");
      const metadataGrid = document.getElementById("metadataGrid");
      const downloadLinks = document.getElementById("downloadLinks");
      const newUploadBtn = document.getElementById("newUploadBtn");
      const uploadSection = document.getElementById("uploadSection");

      let selectedFile = null;

      // Format file size
      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
        return (bytes / (1024 * 1024)).toFixed(1) + " MB";
      }

      // Handle file selection
      function handleFile(file) {
        if (!file) return;

        // Validate file type
        const validTypes = [
          "image/png",
          "image/jpeg",
          "image/jpg",
          "image/bmp",
          "image/tiff",
        ];
        if (
          !validTypes.includes(file.type) &&
          !file.name.match(/\.(png|jpg|jpeg|bmp|tiff|tif)$/i)
        ) {
          showError(
            "Please upload a valid image file (PNG, JPG, JPEG, BMP, TIFF)",
          );
          return;
        }

        selectedFile = file;

        // Show preview
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          previewSection.classList.add("show");
        };
        reader.readAsDataURL(file);

        // Update file info
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileType.textContent = file.type || "image";

        hideError();
      }

      // File input change
      fileInput.addEventListener("change", (e) => {
        handleFile(e.target.files[0]);
      });

      // Drag and drop
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        handleFile(e.dataTransfer.files[0]);
      });

      // Process button click
      processBtn.addEventListener("click", async () => {
        if (!selectedFile) return;

        // Show processing state
        previewSection.classList.remove("show");
        processingState.classList.add("show");
        hideError();

        // Create form data
        const formData = new FormData();
        formData.append("file", selectedFile);

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          processingState.classList.remove("show");

          if (!response.ok || data.error) {
            showError(data.error || data.details || "Processing failed");
            previewSection.classList.add("show");
            return;
          }

          // Show results
          showResults(data);
        } catch (error) {
          processingState.classList.remove("show");
          showError("Network error: " + error.message);
          previewSection.classList.add("show");
        }
      });

      // Show results
      function showResults(data) {
        uploadSection.style.display = "none";
        resultsSection.classList.add("show");

        // Original image
        const originalImg = document.getElementById("originalImg");
        const originalCard = document.getElementById("originalCard");
        originalImg.src = data.files.original;
        originalCard.style.display = "block";

        // Digitized B/W image
        if (data.files && data.files.digitized) {
          waveformImg.src = data.files.digitized;
          waveformCard.style.display = "block";
        } else {
          waveformCard.style.display = "none";
        }

        // Plot image
        const plotImg = document.getElementById("plotImg");
        const plotCard = document.getElementById("plotCard");
        if (data.files && data.files.plot) {
          plotImg.src = data.files.plot;
          plotCard.style.display = "block";
        } else {
          plotCard.style.display = "none";
        }

        // CSV Data Preview
        const csvSection = document.getElementById("csvSection");
        const csvTable = document.getElementById("csvTable");
        const totalRows = document.getElementById("totalRows");

        if (data.csv_preview) {
          csvSection.classList.add("show");
          totalRows.textContent = data.csv_preview.total_rows;

          // Build table
          let tableHTML = "<thead><tr>";
          data.csv_preview.headers.forEach((header) => {
            tableHTML += `<th>${header}</th>`;
          });
          tableHTML += "</tr></thead><tbody>";

          data.csv_preview.data.forEach((row) => {
            tableHTML += "<tr>";
            row.forEach((cell) => {
              // Format numbers to 4 decimal places if it's a number
              const value = isNaN(cell) ? cell : parseFloat(cell).toFixed(4);
              tableHTML += `<td>${value}</td>`;
            });
            tableHTML += "</tr>";
          });
          tableHTML += "</tbody>";

          csvTable.innerHTML = tableHTML;
        } else {
          csvSection.classList.remove("show");
        }

        // Download links - digitized image, plot, and CSV
        downloadLinks.innerHTML = "";
        if (data.files && data.files.digitized) {
          addDownloadLink("üñºÔ∏è Download Digitized Image", data.files.digitized);
        }
        if (data.files && data.files.plot) {
          addDownloadLink("üìà Download Plot", data.files.plot);
        }
        if (data.files && data.files.csv) {
          addDownloadLink("üìÑ Download CSV Data", data.files.csv);
        }
      }

      // Add download link
      function addDownloadLink(text, url) {
        const link = document.createElement("a");
        link.className = "download-link";
        link.href = url;
        link.download = "";
        link.textContent = text;
        link.style.fontSize = "1.1rem";
        link.style.padding = "15px 30px";
        downloadLinks.appendChild(link);
      }

      // Show error
      function showError(message) {
        errorText.textContent = message;
        errorMessage.classList.add("show");
      }

      // Hide error
      function hideError() {
        errorMessage.classList.remove("show");
      }

      // New upload button
      newUploadBtn.addEventListener("click", () => {
        resultsSection.classList.remove("show");
        uploadSection.style.display = "block";
        previewSection.classList.remove("show");
        selectedFile = null;
        fileInput.value = "";
      });
    </script>
  </body>
</html>
